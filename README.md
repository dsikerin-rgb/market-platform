# Market Platform — цифровая система управления рынком

Платформа для управляющей компании и арендаторов: договоры, начисления/оплаты, документы, заявки на ТО, уведомления и дальнейшие интеграции.

---

## Цели

- Свести ключевые процессы рынка в одну систему (вместо “табличек и чатов”).
- Снизить ручной труд и повысить прозрачность расчётов.
- Подготовить фундамент под интеграции и внешние клиенты.

---

## Основной функционал MVP

**Управляющая компания**
- Арендаторы, торговые места, договоры, сроки.
- Начисления → счета → оплаты → задолженности.
- Документы (хранение, статусы, сроки).
- Заявки/обращения (ТО/аварии) и контроль исполнения.

**Арендатор**
- Доступ к своим договорам, счетам, оплатам, документам.
- Подача заявок/обращений.
- Уведомления по событиям (по готовности).

---

## Окружения и релизы

Мы работаем по схеме:

- **Local**: разработка и быстрые проверки.
- **Staging**: автодеплой при merge в `main`, проверка “как на сервере”.
- **Production**: деплой **только по тегу релиза** после проверки на staging.

> Важно: staging должен быть закрыт от публичного доступа (BasicAuth/IP allowlist).

---

## Важное про Redis (на одной ВМ несколько проектов)

Redis на сервере общий для проектов, поэтому **обязательное правило**:

- каждому проекту и каждому окружению задаём свой `REDIS_PREFIX`.

Пример:
- `otelpro_prod:`
- `servicedesk_prod:`
- `market_staging:`
- `market_prod:`

Это предотвращает пересечения ключей кеша/очередей между проектами.

### Правила (обязательно)
1) **Всегда** задаём `REDIS_PREFIX` (даже если сегодня Redis “не используется”).
2) После изменения `.env` выполняем: `php artisan config:clear`.
3) Следим, чтобы в `.env` был перевод строки в конце файла (иначе новая переменная может “прилипнуть” к предыдущей строке).

### Быстрая проверка на сервере
- Проверить, что приложение видит префикс:
  - `php artisan tinker --execute="echo config('database.redis.options.prefix').PHP_EOL;"`
- Если после правок `.env` начались странные ошибки — первым делом:
  - убедиться, что переменные не “склеились” (открыть `.env` и проверить строки).

---

## Дорожная карта

### Этап 0. Процесс разработки и контуры окружений
- GitHub: feature-ветки → PR → merge в `main`.
- Staging: автодеплой от `main`.
- Prod: деплой по тегу релиза после проверки staging.
- На одной ВМ: раздельные контуры (домен/папка/`.env`/БД).

### Этап 1. MVP “управление рынком”
- Модели и справочники (арендаторы, места, договоры).
- Финансовый контур (начисления → счета → оплаты → задолженности).
- Заявки/обращения (ТО/аварии) и контроль исполнения.
- Документы и сроки.

### Этап 2. Автоматизация тяжёлых операций
- Импорт данных (Excel/CSV).
- Генерация PDF (счета/акты).
- Рассылки/уведомления.

### Этап 3. Очереди и наблюдаемость (позже)
- Redis для фоновых задач (импорт/PDF/рассылки/интеграции/webhooks).
- **Laravel Horizon** для мониторинга очередей (staging/prod).
- **Laravel Telescope**: только local/staging, закрытый доступ, авто-очистка.

### Этап 4. Внешнее API и документация
- Публичные эндпоинты для приложений/интеграций.
- OpenAPI-спецификация.
- Публикация документации (Stoplight/Swagger UI) с ограничением доступа.

### Этап 5. Дополнительные возможности
- Интеграция с 1С.
- Контроль доступа (СКУД).
- Видеонаблюдение (события/ссылки/архив).
- Акции/маркетинг/рассылки.
- Приложение для покупателей + доставка.
- Внутренний “магазин расходников” для арендаторов.

---

## Рабочий процесс (коротко)

- Одна задача → одна короткая ветка → PR → merge в `main`.
- Не пушим в `main` напрямую.
- Миграции: не правим уже попавшие в `main`, только новые.

---

## Лицензия

MIT (если не определено иначе внутри репозитория).
